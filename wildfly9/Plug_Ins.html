<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Plug Ins - WildFly 9</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    <meta content="Scroll Wiki Publisher" name="generator"/>

    <link type="text/css" rel="stylesheet" href="css/blueprint/liquid.css" media="screen, projection"/>
    <link type="text/css" rel="stylesheet" href="css/blueprint/print.css" media="print"/>
    <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"/><![endif]-->

    <link type="text/css" rel="stylesheet" href="css/content-style.css" media="screen, projection, print"/>
    <link type="text/css" rel="stylesheet" href="css/screen.css" media="screen, projection"/>
    <link type="text/css" rel="stylesheet" href="css/print.css" media="print"/>
    
    <link type="text/css" rel="stylesheet" href="css/jbossorg.css"/>
    <link type="text/css" rel="stylesheet" href="css/docnav.css"/>    
    
    <link type="text/css" rel="stylesheet" href="sh/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="sh/shCoreDefault.css"/>
    <script type="text/javascript" src="sh/shCore.js"></script>
    <script type="text/javascript" src="sh/shBrushAppleScript.js"></script>
    <script type="text/javascript" src="sh/shBrushAS3.js"></script>
    <script type="text/javascript" src="sh/shBrushBash.js"></script>
    <script type="text/javascript" src="sh/shBrushCpp.js"></script>
    <script type="text/javascript" src="sh/shBrushCSharp.js"></script>
    <script type="text/javascript" src="sh/shBrushCss.js"></script>
    <script type="text/javascript" src="sh/shBrushDiff.js"></script>
    <script type="text/javascript" src="sh/shBrushErlang.js"></script>
    <script type="text/javascript" src="sh/shBrushGroovy.js"></script>
    <script type="text/javascript" src="sh/shBrushJava.js"></script>
    <script type="text/javascript" src="sh/shBrushJavaFX.js"></script>
    <script type="text/javascript" src="sh/shBrushJScript.js"></script>
    <script type="text/javascript" src="sh/shBrushPerl.js"></script>
    <script type="text/javascript" src="sh/shBrushPhp.js"></script>
    <script type="text/javascript" src="sh/shBrushPlain.js"></script>
    <script type="text/javascript" src="sh/shBrushPython.js"></script>
    <script type="text/javascript" src="sh/shBrushRuby.js"></script>
    <script type="text/javascript" src="sh/shBrushScala.js"></script>
    <script type="text/javascript" src="sh/shBrushSql.js"></script>
    <script type="text/javascript" src="sh/shBrushVb.js"></script>
    <script type="text/javascript" src="sh/shBrushXml.js"></script>
    
</head>
<body>
    <div class="container" style="min-width: 760px;">
        <div class="block header">
          <p id="title">
            <a class="site_href" href="http://www.jboss.org"><strong>JBoss.org</strong></a>
            <a class="doc_href" href="http://docs.jboss.org"><strong>Community Documentation</strong></a>
          </p>
                  <ul class="docnav">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <li class="previous"><a accesskey="p" href="Examples.html"><strong>Prev</strong></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <li class="next"><a accesskey="n" href="Subsystem_configuration.html"><strong>Next</strong></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </ul>
                    <div>
            <h1>Plug Ins</h1>
          </div>          
          </div>

        <div class="block content">
    <p>
Within WildFly 8 for communication with the management interfaces and for other services exposed using Remoting where username / password authentication is used the use of Digest authentication is preferred over the use of HTTP Basic or SASL Plain so that we can avoid the sending of password in the clear over the network.  For validation of the digests to work on the server we either need to be able to retrieve a users plain text password or we need to be able to obtain a ready prepared hash of their password along with the username and realm.    </p>
    <p>
Previously to allow the addition of custom user stores we have added an option to the realms to call out to a JAAS domain to validate a users username and password, the problem with this approach is that to call JAAS we need the remote user to send in their plain text username and password so that a JAAS LoginModule can perform the validation, this forces us down to use either the HTTP Basic authentication mechanism or the SASL Plain mechanism depending on the transport used which is undesirable as we can not longer use Digest.    </p>
    <p>
To overcome this we now support plugging in custom user stores to support loading a users password, hash and roles from a custom store to allow different stores to be implemented without forcing the authentication back to plain text variant, this article describes the requirements for a plug in and shows a simple example plug-in for use with WildFly 8.    </p>
    <p>
When implementing a plug in there are two steps to the authentication process, the first step is to load the users identity and credential from the relevant store - this is then used to verify the user attempting to connect is valid.  After the remote user is validated we then load the users roles in a second step.  For this reason the support for plug-ins is split into the two stages, when providing a plug-in either of these two steps can be implemented but there is no requirement to implement the other side.    </p>
    <p>
When implementing a plug-in the following interfaces are the bare minimum that need to be implemented so depending on if a plug-in to load a users identity or a plug-in to load a users roles is being implemented you will be implementing one of these interfaces.    </p>
    <p>
<strong class=" "><i class=" ">Note</i></strong> <i class=" ">- All classes and interfaces of the SPI to be implemented are in the 'org.jboss.as.domain.management.plugin' package which is a part of the 'org.jboss.as.domain-management' module but for simplicity for the rest of this section only the short names will be shown.</i>    </p>
    <div class="section-2"  id="80873174_PlugIns-AuthenticationPlugIn"  >
        <h2>AuthenticationPlugIn</h2>
    
    <p>
To implement an <tt class=" ">AuthenticationPlugIn</tt> the following interface needs to be implemened: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface AuthenticationPlugIn&lt;T extends Credential&gt; {
    Identity&lt;T&gt; loadIdentity(final String userName, final String realm) throws IOException;
}</pre>
        </div>
    </div>
    <p>
During the authentication process this method will be called with the user name supplied by the remote user and the name of the realm they are authenticating against, this method call represents that an authentication attempt is occurring but it is the Identity instance that is returned that will be used for the actual authentication to verify the remote user.    </p>
    <p>
The Identity interface is also an interface you will implement: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface Identity&lt;T extends Credential&gt; {
    String getUserName();
    T getCredential();
}</pre>
        </div>
    </div>
    <p>
Additional information can be contained within the Identity implementation although it will not currently be used, the key piece of information here is the Credential that will be returned - this needs to be one of the following: -    </p>
    <div class="section-3"  id="80873174_PlugIns-PasswordCredential"  >
        <h3>PasswordCredential</h3>
    
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public final class PasswordCredential implements Credential {
    public PasswordCredential(final char[] password);
    public char[] getPassword();
    void clear();
}</pre>
        </div>
    </div>
    <p>
The <tt class=" ">PasswordCredential</tt> is already implemented so use this class if you have the plain text password of the remote user, by using this the secured interfaces will be able to continue using the Digest mechanism for authentication.    </p>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-DigestCredential"  >
        <h3>DigestCredential</h3>
    
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public final class DigestCredential implements Credential {
    public DigestCredential(final String hash);
    public String getHash();
}</pre>
        </div>
    </div>
    <p>
This class is also already implemented and should be returned if instead of the plain text password you already have a pre-prepared hash of the username, realm and password.    </p>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-ValidatePasswordCredential"  >
        <h3>ValidatePasswordCredential</h3>
    
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface ValidatePasswordCredential extends Credential {
    boolean validatePassword(final char[] password);
}</pre>
        </div>
    </div>
    <p>
This is a special Credential type to use when it is not possible to obtain either a plain text representation of the password or a pre-prepared hash - this is an interface as you will need to provide an implementation to verify a supplied password.  The down side of using this type of Credential is that the authentication mechanism used at the transport level will need to drop down from Digest to either HTTP Basic or SASL Plain which will now mean that the remote client is sending their credential across the network in the clear.    </p>
    <p>
If you use this type of credential be sure to force the mechanism choice to Plain as described in the configuration section below.    </p>
    </div>
    
    </div>
    
    <div class="section-2"  id="80873174_PlugIns-AuthorizationPlugIn"  >
        <h2>AuthorizationPlugIn</h2>
    
    <p>
If you are implementing a custom mechanism to load a users roles you need to implement the <tt class=" ">AuthorizationPlugIn</tt>    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface AuthorizationPlugIn {
    String[] loadRoles(final String userName, final String realm) throws IOException;
}</pre>
        </div>
    </div>
    <p>
As with the <tt class=" ">AuthenticationPlugIn</tt> this has a single method that takes a users userName and realm - the return type is an array of Strings with each entry representing a role the user is a member of.    </p>
    </div>
    
    <div class="section-2"  id="80873174_PlugIns-PlugInConfigurationSupport"  >
        <h2>PlugInConfigurationSupport</h2>
    
    <p>
In addition to the specific interfaces above there is an additional interface that a plug-in can implement to receive configuration information before the plug-in is used and also to receive a Map instance that can be used to share state between the plug-in instance used for the authentication step of the call and the plug-in instance used for the authorization step.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface PlugInConfigurationSupport {
    void init(final Map&lt;String, String&gt; configuration, final Map&lt;String, Object&gt; sharedState) throws IOException;
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-2"  id="80873174_PlugIns-InstallingandConfiguringaPlugIn"  >
        <h2>Installing and Configuring a Plug-In</h2>
    
    <p>
The next step of this article describes the steps to implement a plug-in provider and how to make it available within WildFly 8&nbsp;and how to configure it.  Example configuration and an example implementation are shown to illustrate this.    </p>
    <p>
The following is an example security realm definition which will be used to illustrate this: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: xml; gutter: false;">&lt;security-realm name=&quot;PlugInRealm&quot;&gt;
   &lt;plug-ins&gt;
      &lt;plug-in module=&quot;org.jboss.as.sample.plugin&quot;/&gt;
   &lt;/plug-ins&gt;
   &lt;authentication&gt;
      &lt;plug-in name=&quot;Sample&quot;&gt;
         &lt;properties&gt;
            &lt;property name=&quot;darranl.password&quot; value=&quot;dpd&quot;/&gt;
            &lt;property name=&quot;darranl.roles&quot; value=&quot;Admin,Banker,User&quot;/&gt;
         &lt;/properties&gt;
      &lt;/plug-in&gt;
   &lt;/authentication&gt;
   &lt;authorization&gt;
      &lt;plug-in name=&quot;Delegate&quot; /&gt;
   &lt;/authorization&gt;
&lt;/security-realm&gt;</pre>
        </div>
    </div>
    <p>
Before looking closely at the packaging and configuration there is one more interface to implement and that is the <tt class=" ">PlugInProvider</tt> interface, that interface is responsible for making PlugIn instances available at runtime to handle the requests.    </p>
    <div class="section-3"  id="80873174_PlugIns-PlugInProvider"  >
        <h3>PlugInProvider</h3>
    
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public interface PlugInProvider {
    AuthenticationPlugIn&lt;Credential&gt; loadAuthenticationPlugIn(final String name);
    AuthorizationPlugIn loadAuthorizationPlugIn(final String name);
}</pre>
        </div>
    </div>
    <p>
These methods are called with the name that is supplied in the plug-in elements that are contained within the authentication and authorization elements of the configuration, based on the sample configuration above the loadAuthenticationPlugIn method will be called with a parameter of 'Sample' and the loadAuthorizationPlugIn method will be called with a parameter of 'Delegate'.    </p>
    <p>
Multiple plug-in providers may be available to the application server so if a <tt class=" ">PlugInProvider</tt> implementation does not recognise a name then it should just return null and the server will continue searching the other providers.  If a <tt class=" ">PlugInProvider</tt> does recognise a name but fails to instantiate the PlugIn then a <tt class=" ">RuntimeException</tt> can be thrown to indicate the failure.    </p>
    <p>
As a server could have many providers registered it is recommended that a naming convention including some form of hierarchy is used e.g. use package style names to avoid conflicts.    </p>
    <p>
For the example the implementation is as follows: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class SamplePluginProvider implements PlugInProvider {

    public AuthenticationPlugIn&lt;Credential&gt; loadAuthenticationPlugIn(String name) {
        if (&quot;Sample&quot;.equals(name)) {
            return new SampleAuthenticationPlugIn();
        }
        return null;
    }

    public AuthorizationPlugIn loadAuthorizationPlugIn(String name) {
        if (&quot;Sample&quot;.equals(name)) {
            return new SampleAuthenticationPlugIn();
        } else if (&quot;Delegate&quot;.equals(name)) {
            return new DelegateAuthorizationPlugIn();
        }
        return null;
    }
}</pre>
        </div>
    </div>
    <p>
The load methods are called for each authentication attempt but it will be an implementation detail of the provider if it decides to return a new instance of the provider each time - in this scenario as we also use configuration and shared state then new instances of the implementations make sense.    </p>
    <p>
To load the provider use a ServiceLoader so within the META-INF/services folder of the jar this project adds a file called '<tt class=" ">org.jboss.as.domain.management.plugin.PlugInProvider</tt>' - this contains a single entry which is the fully qualified class name of the PlugInProvider implementation class.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">org.jboss.as.sample.SamplePluginProvider</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-PackageasaModule"  >
        <h3>Package as a Module</h3>
    
    <p>
To make the <tt class=" ">PlugInProvider</tt> available to the application it is bundled as a module and added to the modules already shipped with WildFly 8.    </p>
    <p>
To add as a module we first need a <tt class=" ">module.xml</tt>: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: xml; gutter: false;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;module xmlns=&quot;urn:jboss:module:1.1&quot; name=&quot;org.jboss.as.sample.plugin&quot;&gt;
    &lt;properties&gt;
    &lt;/properties&gt;

    &lt;resources&gt;
        &lt;resource-root path=&quot;SamplePlugIn.jar&quot;/&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name=&quot;org.jboss.as.domain-management&quot; /&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre>
        </div>
    </div>
    <p>
The interfaces being implemented are in the '<tt class=" ">org.jboss.as.domain-management</tt>' module so a dependency on that module is defined, this <tt class=" ">module.xml</tt> is then placed in the '{<tt class=" ">jboss.home}/modules/org/jboss/as/sample/plugin/main</tt>'.    </p>
    <p>
The compiled classed and <tt class=" ">META-INF/services</tt> as described above are assembled into a jar called <tt class=" ">SamplePlugIn.jar</tt> and also placed into this folder.    </p>
    <p>
Looking back at the sample configuration at the top of the realm definition the following element was added: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: xml; gutter: false;">   &lt;plug-ins&gt;
      &lt;plug-in module=&quot;org.jboss.as.sample.plugin&quot;/&gt;
   &lt;/plug-ins&gt;</pre>
        </div>
    </div>
    <p>
This element is used to list the modules that should be searched for plug-ins.  As plug-ins are loaded during the server start up this search is a lazy search so don't expect a definition to a non existant module or to a module that does not contain a plug-in to report an error.    </p>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-TheAuthenticationPlugIn"  >
        <h3>The AuthenticationPlugIn</h3>
    
    <p>
The example <tt class=" ">AuthenticationPlugIn</tt> is implemented as: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class SampleAuthenticationPlugIn extends AbstractPlugIn {

    private static final String PASSWORD_SUFFIX = &quot;.password&quot;;
    private static final String ROLES_SUFFIX = &quot;.roles&quot;;
    private Map&lt;String, String&gt; configuration;

    public void init(Map&lt;String, String&gt; configuration, Map&lt;String, Object&gt; sharedState) throws IOException {
        this.configuration = configuration;
        // This will allow an AuthorizationPlugIn to delegate back to this instance.
        sharedState.put(AuthorizationPlugIn.class.getName(), this);
    }

    public Identity loadIdentity(String userName, String realm) throws IOException {
        String passwordKey = userName + PASSWORD_SUFFIX;
        if (configuration.containsKey(passwordKey)) {
            return new SampleIdentity(userName, configuration.get(passwordKey));
        }
        throw new IOException(&quot;Identity not found.&quot;);
    }

    public String[] loadRoles(String userName, String realm) throws IOException {
        String rolesKey = userName + ROLES_SUFFIX;
        if (configuration.containsKey(rolesKey)) {
            String roles = configuration.get(rolesKey);
            return roles.split(&quot;,&quot;);
        } else {
            return new String[0];
        }
    }

    private static class SampleIdentity implements Identity {
        private final String userName;
        private final Credential credential;

        private SampleIdentity(final String userName, final String password) {
            this.userName = userName;
            this.credential = new PasswordCredential(password.toCharArray());
        }

        public String getUserName() {
            return userName;
        }

        public Credential getCredential() {
            return credential;
        }
    }
}</pre>
        </div>
    </div>
    <p>
As you can see from this implementation there is also an additional class being extended <tt class=" ">AbstractPlugIn</tt> - that is simply an abstract class that implements the <tt class=" ">AuthenticationPlugIn</tt>, <tt class=" ">AuthorizationPlugIn</tt>, and <tt class=" ">PlugInConfigurationSupport</tt> interfaces already.  The properties that were defined in the configuration are passed in as a Map and importantly for this sample the plug-in adds itself to the shared state map.    </p>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-TheAuthorizationPlugIn"  >
        <h3>The AuthorizationPlugIn</h3>
    
    <p>
The example implementation of the authentication plug in is as follows: -    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class DelegateAuthorizationPlugIn extends AbstractPlugIn {

    private AuthorizationPlugIn authorizationPlugIn;

    public void init(Map&lt;String, String&gt; configuration, Map&lt;String, Object&gt; sharedState) throws IOException {
        authorizationPlugIn = (AuthorizationPlugIn) sharedState.get(AuthorizationPlugIn.class.getName());
    }

    public String[] loadRoles(String userName, String realm) throws IOException {
        return authorizationPlugIn.loadRoles(userName, realm);
    }

}</pre>
        </div>
    </div>
    <p>
This plug-in illustrates how two plug-ins can work together, by the <tt class=" ">AuthenticationPlugIn</tt> placing itself in the shared state map it is possible for the authorization plug-in to make use of it for the loadRoles implementation.    </p>
    <p>
Another option to consider to achieve similar behaviour could be to provide an Identity implementation that also contains the roles and place this in the shared state map - the <tt class=" ">AuthorizationPlugIn</tt> can retrieve this and return the roles.    </p>
    </div>
    
    <div class="section-3"  id="80873174_PlugIns-ForcingPlainTextAuthentication"  >
        <h3>Forcing Plain Text Authentication</h3>
    
    <p>
As mentioned earlier in this article if the <tt class=" ">ValidatePasswordCredential</tt> is going to be used then the authentication used at the transport level needs to be forced from Digest authentication to plain text authentication, this can be achieved by adding a mechanism attribute to the plug-in definition within the authentication element i.e.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: xml; gutter: false;">  &lt;authentication&gt;
    &lt;plug-in name=&quot;Sample&quot; mechanism=&quot;PLAIN&quot;&gt;</pre>
        </div>
    </div>
    </div>
    
    </div>
    
        </div>
              <ul class="docnav">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <li class="previous"><a accesskey="p" href="Examples.html"><strong>Prev</strong>Examples</a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li>
          <li class="home"><a accesskey="h" href="Documentation.html"><strong>Front page</strong></a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <li class="next"><a accesskey="n" href="Subsystem_configuration.html"><strong>Next</strong>Subsystem configuration</a></li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </ul>
          </div>
    <script type="text/javascript">
      SyntaxHighlighter.all()
    </script>
</body>
</html>
